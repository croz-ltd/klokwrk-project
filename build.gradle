buildscript {
  repositories {
    maven { url "https://plugins.gradle.org/m2/" }
  }

  dependencies {
    classpath "fr.brouillard.oss.gradle:gradle-jgitver-plugin:$gradleJgitverPluginVersion"
    classpath "org.springframework.boot:spring-boot-gradle-plugin:$springBootVersion"
  }
}

// To enable "clean" task on the root project
apply plugin: "base"

apply plugin: "fr.brouillard.oss.gradle.jgitver"

jgitver {
  mavenLike true
  policy {
    pattern = "(.*)"
    transformations = ["IGNORE"]
  }
}

configure(subprojects) {
  group = "net.croz.cargo-tracker"
}

configure(subprojects.findAll({ !["cargo-tracker-platform"].contains(it.name) })) {
  repositories {
    mavenCentral()
  }

  apply plugin: "groovy"
  apply plugin: "maven-publish"
  apply plugin: "idea"

  java {
    sourceCompatibility = JavaVersion .VERSION_1_8
    targetCompatibility = JavaVersion .VERSION_1_8

    withSourcesJar()
  }

  test {
    jvmArgs = ["-noverify", "-XX:TieredStopAtLevel=1"]
    useJUnitPlatform()
  }

  tasks.register("groovyDocJar", Jar) {
    dependsOn groovydoc
    classifier "groovydoc"
    from groovydoc.destinationDir
  }

  publishing {
    publications {
      myLibrary(MavenPublication) {
        from components.java
        artifact groovyDocJar
      }
    }
  }

  // NOTE: This fixes IDEA configuration of Groovy projects and this is necessary for IDEA to recognize spring metadata files generated by Spring Boot annotation processing.
  //       - https://youtrack.jetbrains.com/issue/IDEA-215137
  //       - https://youtrack.jetbrains.com/issue/IDEA-211520
  idea {
    module {
      inheritOutputDirs = false
      outputDir = file("build/classes/groovy/main")
      testOutputDir = file("build/classes/groovy/test")
    }
  }

  dependencies {
    implementation platform(project(":cargo-tracker-platform"))
    annotationProcessor platform(project(":cargo-tracker-platform"))
  }
}
